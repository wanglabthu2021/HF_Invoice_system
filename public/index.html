<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>发票信息提交系统</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Arial', sans-serif; }
        body { background-color: #f5f5f5; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        input[type="text"], input[type="date"], input[type="number"], input[type="file"], select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        input[type="number"] { -moz-appearance: textfield; }
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .btn { background-color: #4CAF50; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; transition: background-color 0.3s; }
        .btn:hover { background-color: #45a049; }
        .error { color: #ff0000; font-size: 14px; margin-top: 5px; }
        .success { color: #4CAF50; font-size: 14px; margin-top: 5px; }
        .form-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .form-row .form-group { flex: 1; margin-bottom: 0; }
        @media (max-width: 768px) { .form-row { flex-direction: column; } }
    </style>
</head>
<body>
<div class="container">
    <h1>发票信息提交</h1>
    <form id="invoiceForm" enctype="multipart/form-data">
        <div class="form-row">
            <div class="form-group">
                <label for="invoiceNumber">发票号 *</label>
                <input type="text" id="invoiceNumber" name="invoiceNumber" required>
                <div id="invoiceNumberError" class="error"></div>
            </div>
            <div class="form-group">
                <label for="invoiceDate">发票日期 *</label>
                <input type="date" id="invoiceDate" name="invoiceDate" required>
                <div id="invoiceDateError" class="error"></div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="amount">金额 (元) *</label>
                <input type="number" id="amount" name="amount" step="0.01" min="0" required>
                <div id="amountError" class="error"></div>
            </div>
            <div class="form-group">
                <label for="currency">币种</label>
                <select id="currency" name="currency">
                    <option value="CNY">人民币 (CNY)</option>
                    <option value="USD">美元 (USD)</option>
                    <option value="EUR">欧元 (EUR)</option>
                    <option value="JPY">日元 (JPY)</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="sellerOption">销售方 *</label>
                <select id="sellerOption" name="sellerOption" required>
                    <option value="">请选择</option>
                    <option value="团购群">团购群</option>
                    <option value="英潍捷基">英潍捷基</option>
                    <option value="其他">其他</option>
                </select>
                <div id="sellerOptionError" class="error"></div>
            </div>
            <div class="form-group" id="otherSellerGroup" style="display:none;">
                <label for="sellerOther">其他销售方，请说明</label>
                <input type="text" id="sellerOther" name="sellerOther">
            </div>
        </div>

        <div class="form-group">
            <label for="contact">销售方联系方式</label>
            <input type="text" id="contact" name="contact">
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="buyer">订购人</label>
                <input type="text" id="buyer" name="buyer">
            </div>
            <div class="form-group">
                <label for="contact">订购时间</label>
                <input type="date" id="orderDate" name="orderDate">
            </div>
        </div>

        <div class="form-group">
            <label for="invoiceType">发票类型</label>
            <select id="invoiceType" name="invoiceType">
                <option value="增值税专用发票">增值税专用发票</option>
                <option value="增值税普通发票">增值税普通发票</option>
                <option value="电子发票">电子发票</option>
                <option value="其他">其他</option>
            </select>
        </div>

        <div class="form-group">
            <label for="description">商品/服务描述</label>
            <textarea id="description" name="description" rows="4"></textarea>
        </div>

        <div class="form-group">
            <label for="invoiceImage">上传发票图片 *</label>
            <input type="file" id="invoiceImage" name="invoiceImage" accept="image/*" required>
            <div id="invoiceImageError" class="error"></div>
        </div>

        <div class="form-group">
            <label for="signImage">上传签收单 *</label>
            <input type="file" id="signImage" name="signImage" accept="image/*" required>
            <div id="signImageError" class="error"></div>
        </div>

        <div class="form-group">
            <label for="notes">备注信息</label>
            <textarea id="notes" name="notes" rows="3"></textarea>
        </div>

        <button type="submit" class="btn">提交发票信息</button>
        <div id="submitStatus" class="success"></div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('invoiceForm');
    const statusEl = document.getElementById('submitStatus');
    const sellerOption = document.getElementById('sellerOption');
    const otherSellerGroup = document.getElementById('otherSellerGroup');

    // 显示“其他销售方”输入框
    sellerOption.addEventListener('change', () => {
        otherSellerGroup.style.display = sellerOption.value === '其他' ? 'block' : 'none';
    });

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        statusEl.textContent = '';
        document.querySelectorAll('.error').forEach(el => el.textContent = '');

        let isValid = true;
        const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
        const invoiceDate = document.getElementById('invoiceDate').value;
        const amount = parseFloat(document.getElementById('amount').value);
        const invoiceImage = document.getElementById('invoiceImage').files[0];
        const signImage = document.getElementById('signImage').files[0];
        const sellerOptVal = sellerOption.value;
        const sellerOther = document.getElementById('sellerOther').value;

        // 基础验证
        if (!invoiceNumber || invoiceNumber.length < 6) { document.getElementById('invoiceNumberError').textContent = '发票号至少需要6个字符'; isValid = false; }
        if (!invoiceDate) { document.getElementById('invoiceDateError').textContent = '请选择发票日期'; isValid = false; }
        if (!amount || amount <= 0) { document.getElementById('amountError').textContent = '请输入有效的金额'; isValid = false; }
        if (!sellerOptVal) { document.getElementById('sellerOptionError').textContent = '请选择销售方'; isValid = false; }
        if (sellerOptVal === '其他' && !sellerOther.trim()) { document.getElementById('sellerOptionError').textContent = '请填写其他销售方'; isValid = false; }
        if (!invoiceImage) { document.getElementById('invoiceImageError').textContent = '请上传发票图片'; isValid = false; }
        else if (invoiceImage.size > 5*1024*1024) { document.getElementById('invoiceImageError').textContent = '图片大小不能超过5MB'; isValid = false; }
        if (!signImage) { document.getElementById('signImageError').textContent = '请上传签收单'; isValid = false; }
        else if (signImage.size > 5*1024*1024) { document.getElementById('signImageError').textContent = '签收单大小不能超过5MB'; isValid = false; }

        if (!isValid) return;

        try {
            // 上传发票
            const invoiceForm = new FormData();
            invoiceForm.append('file', invoiceImage);
            const invoiceResp = await fetch('/api/upload', { method: 'POST', body: invoiceForm });
            if (!invoiceResp.ok) throw new Error('发票上传失败');
            const { url: invoiceUrl } = await invoiceResp.json();

            // 上传签收单
            const signForm = new FormData();
            signForm.append('file', signImage);
            const signResp = await fetch('/api/upload', { method: 'POST', body: signForm });
            if (!signResp.ok) throw new Error('签收单上传失败');
            const { url: signUrl } = await signResp.json();

            // 提交到 Supabase
            const invoiceData = {
                invoiceNumber,
                invoiceDate,
                amount,
                currency: document.getElementById('currency').value,
                sellerOption: sellerOptVal,
                sellerOther: sellerOther,
                buyer: document.getElementById('buyer').value,
                contact: document.getElementById('contact').value,
                orderDate: document.getElementById('orderDate').value,
                invoiceType: document.getElementById('invoiceType').value,
                description: document.getElementById('description').value,
                notes: document.getElementById('notes').value,
                invoiceUrl,
                signUrl
            };

            const resp = await fetch('/api/invoice', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(invoiceData)
            });
            if (!resp.ok) throw new Error('提交发票信息失败');

            statusEl.textContent = '发票提交成功！';
            form.reset();
            otherSellerGroup.style.display = 'none';

        } catch(err) {
            console.error(err);
            statusEl.textContent = '提交失败，请重试';
        }
    });
});
</script>
</body>
</html>
